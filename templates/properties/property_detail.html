{% extends "base.html" %}

{% block title %}房源详情{% endblock %}

{% block content %}
<h2>房源详情</h2>
<hr>

<div class="row">
    <!-- 图片展示区域 -->
    <div class="col-md-6 mb-3">
        {% if images %}
        <div id="propertyImageCarousel" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
                {% for image in images %}
                <div class="carousel-item {% if forloop.first %}active{% endif %}">
                    <img src="{{ image.image.url }}" class="d-block w-100" alt="{{ image.description|default:property }}" style="height: 400px; object-fit: cover; border-radius: 10px;">
                    {% if image.description %}
                    <div class="carousel-caption d-none d-md-block bg-dark bg-opacity-50 rounded">
                        <p>{{ image.description }}</p>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% if images|length > 1 %}
            <button class="carousel-control-prev" type="button" data-bs-target="#propertyImageCarousel" data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">上一张</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#propertyImageCarousel" data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">下一张</span>
            </button>
            {% endif %}
        </div>
        
        <!-- 缩略图 -->
        {% if images|length > 1 %}
        <div class="row mt-2">
            {% for image in images %}
            <div class="col-3">
                <img src="{{ image.image.url }}" class="img-thumbnail" alt="{{ image.description|default:property }}" 
                     onclick="$('#propertyImageCarousel').carousel({{ forloop.counter0 }})" 
                     style="cursor: pointer; height: 80px; object-fit: cover;">
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% else %}
        <div class="card" style="height: 400px; display: flex; align-items: center; justify-content: center; background: #f8f9fa;">
            <div class="text-center text-muted">
                <i class="bi bi-image" style="font-size: 4rem;"></i>
                <p class="mt-3">暂无图片</p>
            </div>
        </div>
        {% endif %}
    </div>
    
    <!-- 房源信息 -->
    <div class="col-md-6">
        <div class="card mb-3">
            <div class="card-body">
                <h4>{{ property.project.name }}</h4>
                <p><strong>位置:</strong> {{ property.building_number }}-{{ property.unit_number }}-{{ property.room_number }}</p>
                <p><strong>楼层:</strong> {{ property.floor }}层</p>
                <p><strong>建筑面积:</strong> {{ property.building_area }}㎡</p>
                <p><strong>套内面积:</strong> {{ property.interior_area }}㎡</p>
                <p><strong>公摊面积:</strong> {{ property.shared_area }}㎡</p>
                <p><strong>单价:</strong> ¥{{ property.unit_price|floatformat:0 }}/㎡</p>
                <p><strong>总价:</strong> ¥{{ property.total_price|floatformat:0 }}</p>
                <p><strong>状态:</strong> 
                    <span class="badge bg-{% if property.status == 'available' %}success{% elif property.status == 'reserved' %}warning{% else %}secondary{% endif %}">
                        {{ property.get_status_display }}
                    </span>
                </p>
                {% if property.location_description %}
                <p><strong>位置描述:</strong> {{ property.location_description }}</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if user.is_manager or user.is_admin %}
<div class="mb-3">
    <a href="{% url 'properties:property_update' property.pk %}" class="btn btn-primary">编辑</a>
    <a href="{% url 'properties:price_update' property.pk %}" class="btn btn-warning">调价</a>
    <a href="{% url 'properties:image_upload' property.pk %}" class="btn btn-success">
        <i class="bi bi-image"></i> 上传图片
    </a>
    <a href="{% url 'properties:property_list' %}" class="btn btn-secondary">返回列表</a>
</div>
{% endif %}

<!-- 图片管理（仅管理员和销售经理） -->
{% if user.is_manager or user.is_admin %}
{% if images %}
<div class="card mb-3">
    <div class="card-header">
        <h5 class="mb-0">图片管理</h5>
    </div>
    <div class="card-body">
        <div class="row">
            {% for image in images %}
            <div class="col-md-3 mb-3">
                <div class="card">
                    <img src="{{ image.image.url }}" class="card-img-top" alt="{{ image.description|default:property }}" style="height: 150px; object-fit: cover;">
                    <div class="card-body p-2">
                        <p class="card-text small mb-1">
                            {% if image.is_main %}<span class="badge bg-primary">主图</span>{% endif %}
                            {{ image.description|default:"无描述" }}
                        </p>
                        <a href="{% url 'properties:image_delete' property.pk image.pk %}" class="btn btn-sm btn-danger" onclick="return confirm('确定要删除这张图片吗？')">
                            <i class="bi bi-trash"></i> 删除
                        </a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}
{% endif %}

{% if price_history %}
<h4>价格历史</h4>
<table class="table table-striped">
    <thead>
        <tr>
            <th>单价(元/㎡)</th>
            <th>总价(元)</th>
            <th>调价原因</th>
            <th>修改人</th>
            <th>修改时间</th>
        </tr>
    </thead>
    <tbody>
        {% for history in price_history %}
        <tr>
            <td>{{ history.unit_price|floatformat:0 }}</td>
            <td>{{ history.total_price|floatformat:0 }}</td>
            <td>{{ history.reason|default:"无" }}</td>
            <td>{{ history.changed_by.username|default:"系统" }}</td>
            <td>{{ history.changed_at|date:"Y-m-d H:i" }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endif %}
{% endblock %}

